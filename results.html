<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - Nearest Hospitals</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <a href="booking.html" class="back-btn" title="Back to Booking">‚Üê</a>
    
    <div class="section-container">
        <h2>üè• Nearest Hospitals</h2>
        
        <div id="bookingInfo" class="status-message status-info" style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 0.5rem; color: #00d4ff;">üìã Your Booking Details</h3>
            <div id="bookingDetails"></div>
        </div>
        
        <div id="hospitalList" class="button-grid">
            <!-- Hospitals will be dynamically loaded here -->
        </div>
        
        <div class="feature-card" style="margin-top: 2rem; background: rgba(0, 255, 133, 0.1); border-color: rgba(0, 255, 133, 0.3);">
            <h3 style="color: #00ff85;">‚úÖ What Happens Next?</h3>
            <div style="text-align: left; color: #a1a1aa; line-height: 1.6;">
                <p>1. <strong>Call the ambulance</strong> using the phone number provided</p>
                <p>2. <strong>Confirm your exact location</strong> with the driver</p>
                <p>3. <strong>Prepare necessary documents</strong> (ID, insurance cards)</p>
                <p>4. <strong>Stay calm</strong> and wait for the ambulance to arrive</p>
            </div>
        </div>
        
        <div class="button-grid" style="margin-top: 2rem;">
            <a href="firstaid.html" class="btn-secondary">
                ü©π First Aid Guide
            </a>
            <a href="track-by-booking-id.html" class="btn-primary">
                üîç Track This Booking
            </a>
        </div>
    </div>

    <div id="map" style="height: 400px; margin-top: 2rem;"></div>

    <script>
        // Display booking information
        function displayBookingInfo() {
            const bookingData = JSON.parse(localStorage.getItem('currentBooking') || '{}');
            const detailsDiv = document.getElementById('bookingDetails');
            
            if (bookingData.bookingId) {
                detailsDiv.innerHTML = `
                    <p><strong>Booking ID:</strong> ${bookingData.bookingId}</p>
                    <p><strong>Location:</strong> ${bookingData.location}</p>
                    <p><strong>Phone:</strong> ${bookingData.phone}</p>
                    ${bookingData.emergency ? `<p><strong>Emergency:</strong> ${bookingData.emergency}</p>` : ''}
                    <p><strong>Time:</strong> ${new Date(bookingData.timestamp).toLocaleString()}</p>
                `;
            } else {
                detailsDiv.innerHTML = '<p>No booking information available</p>';
            }
        }

        // Hospitals will be filled by Places API in initMap(); display fallback message if needed.

        // Get directions function (OpenStreetMap)
        function getDirections(hospitalLat, hospitalLon) {
            const userLat = localStorage.getItem('latitude');
            const userLon = localStorage.getItem('longitude');
            if (userLat && userLon) {
                const url = `https://www.openstreetmap.org/directions?from=${userLat},${userLon}&to=${hospitalLat},${hospitalLon}`;
                window.open(url, '_blank');
            } else {
                alert('User location not available for directions.');
            }
        }

        // Haversine distance (km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Emergency call function
        function callEmergency() {
            if (confirm('This will dial the national emergency number 108. Continue?')) {
                window.location.href = 'tel:108';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            displayBookingInfo();
        });

        // Add some interactive features
        document.addEventListener('DOMContentLoaded', function() {
            // Add emergency call button
            const emergencyBtn = document.createElement('div');
            emergencyBtn.innerHTML = `
                <button onclick="callEmergency()" 
                        style="position: fixed; bottom: 2rem; right: 2rem; background: linear-gradient(135deg, #ff007b, #ff00d4); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; font-size: 2rem; cursor: pointer; box-shadow: 0 8px 24px rgba(255, 0, 123, 0.4); z-index: 1000; transition: all 0.3s ease;"
                        onmouseover="this.style.transform='scale(1.1)'"
                        onmouseout="this.style.transform='scale(1)'"
                        title="Call Emergency 108">
                    üö®
                </button>
            `;
            document.body.appendChild(emergencyBtn);
        });

        function initMap() {
            // Prefer coordinates saved with the booking (if user clicked Get Location then submitted)
            const bookingData = JSON.parse(localStorage.getItem('currentBooking') || '{}');
            let userLat = bookingData.coordinates ? parseFloat(bookingData.coordinates.lat) : parseFloat(localStorage.getItem("latitude"));
            let userLon = bookingData.coordinates ? parseFloat(bookingData.coordinates.lng) : parseFloat(localStorage.getItem("longitude"));

            function buildLeafletMapAndSearch(lat, lon) {
                const map = L.map('map').setView([lat, lon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);

                L.marker([lat, lon]).addTo(map).bindPopup('Your Location').openPopup();

                // Overpass API query for nearby hospitals within 5 km
                const radius = 5000;
                const query = `[out:json];(node["amenity"="hospital"](around:${radius},${lat},${lon});way["amenity"="hospital"](around:${radius},${lat},${lon});relation["amenity"="hospital"](around:${radius},${lat},${lon}););out center;`;
                const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const elements = data.elements || [];
                        const hospitals = elements.map(el => {
                            const elLat = el.type === 'node' ? el.lat : (el.center && el.center.lat);
                            const elLon = el.type === 'node' ? el.lon : (el.center && el.center.lon);
                            const name = el.tags && (el.tags.name || el.tags['official_name']) || 'Unnamed Hospital';
                            let addr = '';
                            if (el.tags) {
                                const parts = [];
                                if (el.tags['addr:housenumber']) parts.push(el.tags['addr:housenumber']);
                                if (el.tags['addr:street']) parts.push(el.tags['addr:street']);
                                if (el.tags['addr:city']) parts.push(el.tags['addr:city']);
                                if (el.tags['addr:postcode']) parts.push(el.tags['addr:postcode']);
                                addr = parts.join(', ');
                            }
                            const distance = calculateDistance(lat, lon, elLat, elLon);
                            return { name, addr, lat: elLat, lon: elLon, distance };
                        }).filter(h => Number.isFinite(h.lat) && Number.isFinite(h.lon));

                        hospitals.sort((a,b) => a.distance - b.distance);
                        const top = hospitals.slice(0,5);

                        const hospitalListDiv = document.getElementById('hospitalList');
                        hospitalListDiv.innerHTML = '';

                        if (top.length === 0) {
                            hospitalListDiv.innerHTML = '<p>No nearby hospitals found within 5 km.</p>';
                            return;
                        }

                        top.forEach(h => {
                            const card = document.createElement('div');
                            card.className = 'feature-card hospital-card';
                            card.style.textAlign = 'left';
                            card.innerHTML = `
                                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem;">
                                    <h3 style="color:#00d4ff;margin:0;flex:1;">${h.name}</h3>
                                    <div style="text-align:right;color:#00ff85;font-weight:600;">
                                        <div style="font-size:1.1rem;">${h.distance.toFixed(2)} km</div>
                                    </div>
                                </div>
                                <p style="color:#a1a1aa;margin:0.5rem 0;font-size:0.95rem;">üìç ${h.addr || ''}</p>
                                <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                                    <a href="#" onclick="callEmergency();return false;" class="btn-secondary" style="flex:1;text-decoration:none;display:flex;align-items:center;justify-content:center;padding:0.875rem;">üìû Call Ambulance</a>
                                    <a href="#" onclick="getDirections(${h.lat}, ${h.lon});return false;" class="btn-primary" style="flex:1;display:flex;align-items:center;justify-content:center;">üó∫Ô∏è Directions</a>
                                </div>
                            `;

                            hospitalListDiv.appendChild(card);

                            L.marker([h.lat, h.lon]).addTo(map).bindPopup(h.name);
                        });
                    })
                    .catch(err => {
                        console.error('Overpass error', err);
                        document.getElementById('hospitalList').innerHTML = '<p>Error fetching nearby hospitals.</p>';
                    });
            }

            if (!Number.isFinite(userLat) || !Number.isFinite(userLon)) {
                // Try to geolocate if localStorage doesn't have coords
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(pos) {
                        userLat = pos.coords.latitude;
                        userLon = pos.coords.longitude;
                        localStorage.setItem("latitude", userLat);
                        localStorage.setItem("longitude", userLon);
                        buildLeafletMapAndSearch(userLat, userLon);
                    }, function(err) {
                        document.getElementById('hospitalList').innerHTML = '<p>Location not available. Please go back and provide your location.</p>';
                        console.error('Geolocation error:', err);
                    }, { enableHighAccuracy: true, timeout: 10000 });
                } else {
                    document.getElementById('hospitalList').innerHTML = '<p>Geolocation not supported. Please enter location on booking page.</p>';
                }
            } else {
                buildLeafletMapAndSearch(userLat, userLon);
            }
        }

        // Initialize the map after the page loads
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>